name: CI/CD - Build â†’ Scan â†’ Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: 'Wisdom'
  CLUSTER_NAME: 'infinion-aks-cluster'
  ACR_NAME: 'infinionacr1760906713'
  NAMESPACE: 'infinion'
  IMAGE_NAME: 'infinion-weather-api'


permissions:
  contents: read
  security-events: write
  actions: read
  packages: read

jobs:
  security-scan:
    name:  Security Scanning
    runs-on: ubuntu-latest
    outputs:
      security_passed: ${{ steps.final-check.outputs.result }}
    
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Build project
        run: |
          echo " Building .NET application..."
          dotnet build devops-api.sln --configuration Release
          dotnet test devops-api.sln --verbosity normal

      - name: Run Trivy filesystem scan
        id: trivy-fs
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: 0
          skip-files: '**/node_modules/**,**/vendor/**,**/bin/**,**/obj/**'

      - name: Upload Trivy results to Security tab
        if: always() && github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          wait-for-processing: false

      - name: Display Trivy results in workflow
        if: always()
        run: |
          echo " Trivy Security Findings Summary:"
          if [ -f "trivy-results.sarif" ]; then
            echo " Trivy scan completed - results saved to security tab"
          else
            echo "  Trivy scan did not generate results file"
          fi

      - name: Run Checkov infrastructure scan
        id: checkov
        run: |
          echo " Running Checkov scan..."
          # Install Checkov
          pip3 install checkov
          
          # Run Checkov and generate SARIF output
          checkov -d . \
            --framework terraform kubernetes dockerfile github_actions \
            --output sarif \
            --output-file-path checkov-results.sarif \
            --soft-fail || echo "Checkov completed with findings"
        continue-on-error: true

      - name: Upload Checkov results to Security tab
        if: always() && github.event_name != 'pull_request' && steps.checkov.outcome == 'success'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'checkov-results.sarif'
          wait-for-processing: false

      - name: Display Checkov results in workflow
        if: always()
        run: |
          echo " Checkov Infrastructure Security Summary:"
          if [ -f "checkov-results.sarif" ]; then
            echo " Checkov scan completed - results saved to security tab"
          else
            echo "  Checkov scan did not generate results file"
          fi

      - name: Final security check
        id: final-check
        run: |
          # Basic check - if we got this far, security scans ran
          echo " Security scanning phase completed"
          echo "result=success" >> $GITHUB_OUTPUT

  build-and-push:
    name: ðŸ³ Build & Container Scan
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Build and push to ACR
        id: build
        run: |
          echo " Building and pushing Docker image to ACR..."
          az acr build --registry $ACR_NAME \
            --image $IMAGE_NAME:${{ github.sha }} \
            --image $IMAGE_NAME:latest \
            --file Dockerfile \
            .
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Scan container image with Trivy
        run: |
          echo " Scanning container image for vulnerabilities..."
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          
          # Scan the newly built image
          trivy image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} \
            --format table \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --ignore-unfixed

      - name: Display container scan summary
        run: |
          echo " Container security scan completed"
          echo " Image: $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}"

  deploy-to-aks:
    name:  Deploy to AKS
    runs-on: ubuntu-latest
    needs: 
      - security-scan
      - build-and-push
    environment: production
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Set AKS context
        run: |
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing

      - name: Deploy to AKS
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          echo " Deploying to AKS..."
          
          # Create namespace if not exists
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply Kubernetes manifests
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/service.yaml
          
          # Update or create deployment
          if kubectl get deployment/infinion-weather-api -n $NAMESPACE &> /dev/null; then
            echo " Updating existing deployment..."
            kubectl set image deployment/infinion-weather-api infinion-weather-api=$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG -n $NAMESPACE --record
          else
            echo " Creating new deployment..."
            sed "s#REPLACE_WITH_ACR_LOGIN#$ACR_NAME.azurecr.io#g; s#REPLACE_TAG#$IMAGE_TAG#g" k8s/deployment.yaml | kubectl apply -f -
          fi
          
          # Wait for rollout to complete
          echo " Waiting for deployment to complete..."
          kubectl rollout status deployment/infinion-weather-api -n $NAMESPACE --timeout=300s

      - name: Verify deployment
        run: |
          echo " Deployment verification..."
          kubectl get all -n $NAMESPACE
          
          # Get service details
          SERVICE_IP=$(kubectl get service infinion-weather-api-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          echo " Weather API URL: http://$SERVICE_IP/weatherforecast"
          
          # Test the API endpoint
          if [ "$SERVICE_IP" != "pending" ]; then
            echo " Testing API endpoint..."
            curl -s --retry 5 --retry-delay 10 http://$SERVICE_IP/weatherforecast | jq . || echo "API still starting..."
          fi

  security-report:
    name:  Security Report
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-push, deploy-to-aks]
    if: always()
    
    permissions:
      contents: read
    
    steps:
      - name: Generate Security Summary
        run: |
          echo " "
          echo " SECURITY & DEPLOYMENT SUMMARY"
          echo "================================="
          echo " Security Scanning: COMPLETED"
          echo " Container Build: COMPLETED" 
          echo " AKS Deployment: ${{ needs.deploy-to-aks.result || 'COMPLETED' }}"
          echo " "
          echo " Security findings available in:"
          echo "   GitHub â†’ Security â†’ Code scanning"
          echo " "
          echo " Live API: http://$(kubectl get service infinion-weather-api-service -n infinion -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo 'DEPLOYED')/weatherforecast"
          echo " "